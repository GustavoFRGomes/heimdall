\chapter{System Architecture}
% Os titulos dados aos capítulos são meros exemplos. Cada relatório deve adequar-se ao projeto desenvolvido.
\label{chap:sys-arch}

\section{Introduction}
\label{chap3:sec:intro}
This chapter will present the architecture chosen for the development of this
system, as well as the tools used for the development of the various components,
this chapter is meant to jsut give a general idea of the tools used not the
specific uses.

\section{Brief Requirement Analysis}
\label{chap3:sec:reqs}

O trecho de código seguinte mostra a função \texttt{main()} e o seu funcionamento:
\begin{lstlisting}[caption=Trecho de código usado no projeto.]
#include <stdio.h>

int main(){
  int i = 0;
  for(i = 0; i < 100; i++)
    printf("%d\n",i);
}
\end{lstlisting}


Se quiser definir a distribuição de Pareto, posso colocar a fórmula \emph{inline}, da seguinte forma $P(x)=\frac{x^{1/\Lambda}_{i}}{2}$, ou numa linha em separada, como se mostra a seguir:
$$ y^2 = \sum_{x=0}^{20}( x^3 - 2x + 3).$$

Outra maneira, mas numerada, é usar o ambiente \texttt{equation}, como se mostra na (\ref{eq:eq1}):
\begin{equation}
 y^2 = \sum_{x=0}^{20}( x^3 - 2x + 3).
 \label{eq:eq1}
\end{equation}

\begin{align}
 2+2+2+2+2+2+2+2+2+2+y^2 = & \sum_{x=0}^{20}( x^3 - 2x + 3);\\
                         = & x^4 -2.
 \label{eq:eq2}
\end{align}

\section{Architecture}
\label{chap3:sec:arch}
% Diagrama de Componentes
The system itself is all on the Raspberry Pi and the Android application is only
the interface that will enable the end-user interact with the firewall and also
receive notifications once the user is connected inside the network.

The components present on the Raspberry Pi are as follows:
\begin{enumerate}
	\item SQLite Database
	\item Web Service API
	\item Firewall Handler
	\item Email Notifier
\end{enumerate}

In the next chapter we will go into more details on these system and how they
all interact with each other. For now we can say that the Database play the
center role because everything needs to interact with it, either to get new
notifications, register flagged occurences or to interact with the web service.
% say database-centric?

\section{Tools}
\label{chap3:sec:tools}
In order to make the entire system feasable in the proposed timeframe there was
the need to use already available tools both in the Linux Operating System and
also on the Android

\subsection{Volley}
\label{chap3:sec:tools:sub:volley}
The Volley package is present in the standard library of Android it is
compatible with the first Android versions of the Operating System, and it helps
the developer to implement a queue of HTTP requests for various URL defined
resources.

This is a great tool for the development of web service consumers, making the
process of sending and receiving requests and responses with both text strings
or with JSON content. This package also helps the developer handle error
messages that might be received as a response from the web service.

\subsection{Flask}
\label{chap3:sec:tools:sub:flask}
\emph{Flask} is a micro-framework for the development of web applications. It
was designed as an small yet extensible framework providing a solid core with
basic services as:
\begin{enumerate}
	\item routing;
	\item debugging;
	\item Web Server Gateway Interface (WSGI);
	\item Template Support.
\end{enumerate}

The main objective with this framework is to avoid any features that might be
unnecessary for any of the developers. In order to make up for this lack of
functionality there is a support for extensions that can amplify these
funcionalities as, for example, authentication, development of web services and
database access. It is up to the developer to choose the extensions they might
need or even implement their own ones.
\emph{Flask} has two main dependencies, which can be divided into \emph{Jinja2} for
template support and \emph{Werkzeug} for the rest of the services mentioned
above.

In the context of this software project the \emph{Flask} framework will be the
foundation of the web service, which will run on the Raspberry Pi, alongside the
email notification, database and firewall interface service. In order to develop
the web service to interact with the Android application there was the
integration of the following extensions:
\begin{enumerate}
	\item flask-sqlalchemy -- to work with the database and its data models.
	\item flask-restful -- for the development of the API structure using the
		REST principles.
	\item flask-httpauth -- to enable the authentication of the users accessing
		the Web API.
\end{enumerate}

% \subsection{SQLite}
% \label{chap3:sec:tools:sub:sqlite}
% The database handling is through the use of the another Python module named
% SQLAlchemy which abstracts the developer from the SQL query language by using
% Python classes to model the SQLite 3 database entities, and also query methods
% for each class that allow the programmer to query and filter the results within
% the database through Python methods.

% The SQLite was the chosen RDBM due to it's low computational resource
% requirements. This databae has a cap of data at 3TB which is more then suficient
% for the purposes of this project.

\subsection{SQLAlchemy}
\label{chap3:sec:tools:sub:sqlalcemy}
SQLAlchemy is a library used to interact with the different SQL databases
available. This modules allows the conversion of the data within the database to
Python objects representing the models for each table. This library is a third
party module, not included in the Python Standard Libraries, that was created by
Mike Bayer in 2005.

This library is widely adopted within the Python developer universe because it
simplifies the access and manipulation of data inside a database. It supports
some of the most common database systems as, for example:
\begin{enumerate}
	\item Postgres
	\item MySQL
	\item SQLite
	\item Oracle
\end{enumerate}
By using this library a developer could abstract the code from the underlying
database and its SQL peculiarities. It also helps with the sanitization of the
data which is inputed to the database preventing common security flaws like SQL
injection attacks.

SQLAlchemy also provides flexibility by having two alternative modes of usage,
which could be used interchangeably depending on the personnal preferences of
the developer, these two distinct ways are:
\begin{enumerate}
	\item SQL Expression Language also known as Core -- is mostly a Pythonic way
		of representing common SQL statements and expressions with almost no
		abstraction from typical SQL language. This is also the foundation of
		the next usage mode.
		% ORM - Object Relational Mapper
	\item ORM -- has a more high-level abstraction and leveraging a declarative
		system that enables the developer to work in a more idiomatic way. This
		is accomplished by binding the database schema with data models
		represented as Python classes.
\end{enumerate}

This project makes extensive use of the SQLAlchemy's ORM mode with a SQLite3
database system.

\subsection{iptables}
\label{chap3:sec:tools:sub:iptables}
The iptables is known as the default firewall system deployed in almost all
GUN/Linux distributions. This firewall system enables the declaration of chains
for complex chains of events that can go from log appending as well as accepting
or blocking packets.

The iptables works by interacting withe the packet filtering hooks provided by
the Netfilter framework, which is present within the GNU/Linux kernel.
This firewall system also allows the interception of packets in various stages
of their traversal through the network card, due to the hooks from the Netfilter
framework. These built-in chains and their
respective hooks are as follows:
\begin{enumerate}
	\item PREROUTING -- NF\_IN\_PRE\_ROUTING
	\item INPUT -- NF\_IN\_LOCAL\_IN
	\item FORWARD -- NF\_IP\_FORWARD
	\item OUPUT -- NF\_IP\_LOCAL\_OUT
	\item POSTROUTING -- NF\_IP\_POST\_ROUTING
\end{enumerate}

\section{Conclusions}
\label{chap3:sec:concs}
In this chapter we have talked about the underlying architecture of the system
as well as the tools that were used in the various components of the project.
We refer the Volley used by the mobile application to request resources from the
Flask web service running a REST API. We also talked about the databate
management system as well as the SQLAlchemy Python module. We ended this chapter
by talking about the iptables firewall system present in GNU/Linux which will be
used as the firewall on the Raspberry Pi gateway.
